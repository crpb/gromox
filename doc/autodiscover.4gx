.\" SPDX-License-Identifier: CC-BY-SA-4.0 or-later
.\" SPDX-FileCopyrightText: 2021-2024 grommunio GmbH
.TH autodiscover 4gx "" "Gromox" "Gromox admin reference"
.SH Name
autodiscover \(em Autodiscover HTTP Service Protocol handler (AutoDiscover
responder)
.SH Description
.PP
A client would make a HTTP request to the /Autodiscover/Autodiscover.xml
endpoint, which is handled by the Gromox oxdisco plugin.
.PP
The Autodiscover response contains a HTTP server (generally the HTTP home
server) and the designated choice for protocol framing. A client uses this to
set up the EMSMDB MAPI service within a MAPI profile. Because the HTTP home
server is then known, Autodiscover is not used again when making a connection
to the message store service. However, the Address Book always issues
Autodiscover requests. (In other words, removing the DNS entry for the
Autodiscover server after a profile is set up would break the address book, but
not the message store.)
.SH URL derivation
Autodiscover (DS) clients can locate an Autodiscover server using a number of
methods. MS-OXDISCO \(sc 3.1.5 specifies the following order, and that clients
should do all of them:
.IP 1. 4
Query a "well-known LDAP server" (in other words, the ActiveDirectory server if
a client is a Windows Domain member) for Service Connection Points (SCP), which
contains AutoDiscover server names.
.IP 2. 4
String construction based on the user's e-mail address; for user@example.com,
retrieval of
\fBhttps://\fP\fIexample.com\fP\fB/autodiscover/autodiscover.xml\fP using the
HTTP POST method.
.IP 3. 4
Retrieval of
\fBhttps://autodiscover.\fP\fIexample.com\fP\fB/autodiscover/autodiscover.xml\fP
using the HTTP POST method.
.IP 4. 4
Lookup of any DNS SRV resource records for "_autodiscover._tcp.example.com",
and if found, using it to retrieve
\fBhttps://\fP\fIsrv-result-name\fP\fB/autodiscover/autodiscover.xml\fP.
.IP 5. 4
Retrieval of
\fBhttps://autodiscover.\fP\fIexample.com\fP\fB/autodiscover/autodiscover.xml\fP
using the HTTP GET method, following any HTTP 302 response.
.SH Outlook behavior
Outlook uses the following actions:
.IP 1. 4
DNS TXT query for the domain; if there is an entry with e.g. ``MS=ms66406244``,
retrieves https://outlook.office365.com/autodiscover/autodiscover.xml.
.IP 2. 4
LDAP/SCP (only if joined to a Windows Domain)
.IP 3. 4
HTTP POST to example.com as per the above
.IP 4. 4
HTTP POST to autodiscover.example.com as per the above
.IP 5. 4
DNS SRV resolution as per the above
.IP 6. 4
Something referred to as "local mechanism"
.IP 7. 4
Redirect check/HTTP GET to autodiscover.example.com as per the above
.PP
Under some circumstances, Outlook's evaluation order may be different; we have
observed {O365, SCP, POST, POST, Local, Redirect, Redirect, SRV} as well.
.PP
Their AutoDiscovery implementation treats a non-responsive server
(firewall DROP policy, or TCP RST) the same as a 404 Not Found response.
.PP
Furthermore, there is a bug in Outlook or the Windows HTTP libraries which
erroneously presents a warning dialog whenever the hostname obtained through
resolution of an SRV record does not match the domain name. Redirection is
however the central idea of an SRV record and, as far as security
considerations go, is no more significant than following a CNAME-typed
autodiscover.example.com record.
.PP
To force using a particular Autodiscover server in Windows, such as when Gromox
is run in a development environment with a fake domain,
c:\\windows\\system32\\drivers\\etc\\hosts can be populated with a static entry
for \fBautodiscover.\fP\fIexample.com\fP to get that particular scenario
working.
.SH gromox-dscli behavior
The gromox-dscli command-line utility uses this order:
.IP 1. 4
HTTP POST to example.com as per the above
.IP 2. 4
HTTP POST to autodiscover.example.com as per the above
.IP 3. 4
DNS SRV as per the above
.SH Configuration directives (gromox.cfg)
The following directives are recognized when they appear in
/etc/gromox/gromox.cfg.
.TP
\fBoxdisco_advertise_mh\fP
This setting controls whether the AutoDiscover response should include a EXHTTP
Protocol section. Possible values: \fIyes\fP, \fIno\fP, \fInot_old_mso\fP,
\fIonly_new_mso\fP. The latter two values can be used to finely control
emission in case of clients other than Outlook.
.br
Default: \fIyes\fP
.TP
\fBoxdisco_advertise_rpch\fP
This setting controls whether the AutoDiscover response should include
EXCH/EXPR Protocol sections. Possible values: \fIyes\fP, \fIno\fP,
\fIonly_old_mso\fP, \fInot_new_mso\fP. The latter two values can be used to
finely control emission in case of clients other than Outlook.
.br
Default: \fIyes\fP
.TP
\fBoxdisco_exonym\fP
Globally valid name pointing to the Autodiscover server.
.br
Default: (same value as host_id)
.TP
\fBoxdisco_pretty_response\fP
A debugging knob to make the module emit indented XML responses.
.br
Default: \fIno\fP
.TP
\fBoxdisco_request_logging\fP
Log AutoDiscover requests. This is independent of http.cfg:http_debug, and
setting both would log requests twice.
.br
Default: \fIno\fP
.TP
\fBoxdisco_response_logging\fP
Log AutoDiscover responses. This is independent of http.cfg:http_debug, and
setting both would log responses twice.
.br
Default: \fIno\fP
.TP
\fBoxdisco_validate_scndrequest\fP
When OL opens a non-default store (store of another user) or a public store, it
may also make an AutoDiscover inquiry for the extra store. This setting
controls whether the server-side AutoDiscover module should perform a
permission check on non-default stores and possibly reject returning connection
details. (Inquiry of public stores are always permitted.)
.br
Default: \fIyes\fP
.TP
\fBx500_org_name\fP
.br
Default: (unspecified)
.SH Configuration directives (autodiscover.cfg)
The following directives are recognized when they appear in
/etc/gromox/autodiscover.cfg. autodiscover.cfg is obsolete in favor of
gromox.cfg.
.TP
\fBx500_org_name\fP
Same as gromox.cfg:x500_org_name.
.br
Default: (unspecified)
.SH Configuration directives (autodiscover.ini)
The following directives are recognized when they appear in
/etc/gromox/autodiscover.ini. autodiscover.ini is obsolete in favor of
gromox.cfg.
.TP
\fBorganization\fP
Same as gromox.cfg:x500_org_name.
.SH Outlook notes
When Outlook is active, it is possible to Ctrl-MouseBtn3 (right click) on the
status tray icon to call up a context menu, from which "Test Email
Autoconfiguration..." can be selected to debug AutoDiscover requests and
responses from the Windows side.
.SH Normative references
.IP \(bu 4
MS-OXDISCO: Autodiscover HTTP Service Protocol
.IP \(bu 4
MS-OXDSCLI: Autodiscover Publishing and Lookup Protocol
.SH See also
\fBgromox\fP(7)
